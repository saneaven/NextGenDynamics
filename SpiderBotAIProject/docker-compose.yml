services:
  train:
    build:
      context: .
      dockerfile: docker/Dockerfile
      network: host
    image: spiderbot-isaaclab

    # Isaac Lab docs recommend host networking for headless training.
    network_mode: host

    # Requires Docker with NVIDIA container runtime and a supported Compose plugin.
    gpus: all

    environment:
      ACCEPT_EULA: "Y"
      PRIVACY_CONSENT: "Y"

      # Map container runtime user to host user to avoid root-owned artifacts in the repo mount.
      LOCAL_UID: ${UID:-1000}
      LOCAL_GID: ${GID:-1000}
      LOCAL_USER: ${LOCAL_USER:-isaac}
      HOME: /home/${LOCAL_USER:-isaac}

      # Make the extension importable without a pip editable install.
      PYTHONPATH: /workspace/SpiderBotAIProject/source/SpiderBotAIProject

    working_dir: /workspace/SpiderBotAIProject
    volumes:
      # Project source
      - ./:/workspace/SpiderBotAIProject:rw

      # Isaac Lab / Isaac Sim caches (persist across runs)
      - isaac-cache-kit:/isaac-sim/kit/cache:rw
      - isaac-cache-ov:/home/${LOCAL_USER:-isaac}/.cache/ov:rw
      - isaac-cache-pip:/home/${LOCAL_USER:-isaac}/.cache/pip:rw
      - isaac-cache-gl:/home/${LOCAL_USER:-isaac}/.cache/nvidia/GLCache:rw
      - isaac-cache-compute:/home/${LOCAL_USER:-isaac}/.nv/ComputeCache:rw
      - isaac-logs:/home/${LOCAL_USER:-isaac}/.nvidia-omniverse/logs:rw
      - isaac-data:/home/${LOCAL_USER:-isaac}/.local/share/ov/data:rw
      - isaac-documents:/home/${LOCAL_USER:-isaac}/Documents:rw

    command: >
      /workspace/isaaclab/isaaclab.sh -p /workspace/SpiderBotAIProject/scripts/skrlcustom/train.py --task=SpiderBotAIProject-v0 --headless


volumes:
  isaac-cache-kit: {}
  isaac-cache-ov: {}
  isaac-cache-pip: {}
  isaac-cache-gl: {}
  isaac-cache-compute: {}
  isaac-logs: {}
  isaac-data: {}
  isaac-documents: {}
