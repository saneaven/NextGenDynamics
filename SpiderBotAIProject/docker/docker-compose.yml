version: "3.8"

services:
  # Base service configuration
  spiderbot:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        ISAAC_LAB_VERSION: "${ISAAC_LAB_VERSION:-2.3.1}"
    image: spiderbot-ai:${IMAGE_TAG:-latest}
    container_name: spiderbot-ai

    # GPU Configuration - requires NVIDIA Container Toolkit
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    # Network configuration for headless operation
    network_mode: host

    # Environment variables
    environment:
      - ACCEPT_EULA=Y
      - PRIVACY_CONSENT=Y
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all

    # Volume mounts for persistence
    volumes:
      # Project source (for development - live editing)
      - ../source:/workspace/spiderbot/source:rw
      - ../scripts:/workspace/spiderbot/scripts:ro

      # Output persistence
      - spiderbot-logs:/workspace/spiderbot/logs
      - spiderbot-outputs:/workspace/spiderbot/outputs
      - spiderbot-checkpoints:/workspace/spiderbot/checkpoints
      - spiderbot-videos:/workspace/spiderbot/videos

      # Isaac Sim cache directories (improves startup time)
      - isaac-cache-kit:/isaac-sim/kit/cache
      - isaac-cache-ov:/root/.cache/ov
      - isaac-cache-pip:/root/.cache/pip
      - isaac-cache-glcache:/root/.cache/nvidia/GLCache
      - isaac-cache-computecache:/root/.nv/ComputeCache

      # Omniverse logs and data
      - isaac-logs:/root/.nvidia-omniverse/logs
      - isaac-data:/root/.local/share/ov/data

    # Interactive mode
    stdin_open: true
    tty: true

    # Working directory
    working_dir: /workspace/spiderbot

  # Training service (headless)
  train:
    extends:
      service: spiderbot
    container_name: spiderbot-train
    command: >
      /isaac-sim/python.sh scripts/skrlcustom/train.py
      --task=SpiderBotAIProject-v0
      --headless
      --num_envs=${NUM_ENVS:-512}

  # Evaluation service (headless with video recording)
  play:
    extends:
      service: spiderbot
    container_name: spiderbot-play
    command: >
      /isaac-sim/python.sh scripts/skrlcustom/play.py
      --task=SpiderBotAIProject-v0
      --headless
      --checkpoint=${CHECKPOINT_PATH:-/workspace/spiderbot/checkpoints/latest.pt}

# Named volumes for data persistence
volumes:
  spiderbot-logs:
    name: spiderbot-logs
  spiderbot-outputs:
    name: spiderbot-outputs
  spiderbot-checkpoints:
    name: spiderbot-checkpoints
  spiderbot-videos:
    name: spiderbot-videos
  isaac-cache-kit:
    name: isaac-cache-kit
  isaac-cache-ov:
    name: isaac-cache-ov
  isaac-cache-pip:
    name: isaac-cache-pip
  isaac-cache-glcache:
    name: isaac-cache-glcache
  isaac-cache-computecache:
    name: isaac-cache-computecache
  isaac-logs:
    name: isaac-logs
  isaac-data:
    name: isaac-data
